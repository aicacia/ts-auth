import{w as j,h as x}from"./singletons.b58d624b.js";import{q as E}from"./scheduler.0fc17c76.js";import{c as F,s as N,u as b,a as P,P as q}from"./index.6dc2cd99.js";import{g as B}from"./navigation.5c63806d.js";import{b as M}from"./paths.41c4970f.js";const I={};function V(e){return e}function $(e){return e}function k(e,i,t={}){const a=typeof window<"u"&&typeof window.localStorage<"u",w=t.toJSON||$,v=t.fromJSON||V,_=t.setInitial||!0;function p(l,n){return a&&window.localStorage.setItem(l,JSON.stringify(w(n))),n}if(!I[e]){let o=function(f){p(e,f),r(f)};const l=j(i,f=>{const m=a?window.localStorage.getItem(e):null;if(m?f(v(JSON.parse(m))):_&&p(e,i),a){let c=function(d){d.key===e&&f(d.newValue?v(JSON.parse(d.newValue)):null)};return window.addEventListener("storage",c),()=>{window.removeEventListener("storage",c)}}}),{subscribe:n,set:r}=l;I[e]={set:o,update(f){o(f(E(l)))},subscribe:n}}return I[e]}const A=j(typeof navigator=="object"?navigator.onLine:!1),z=x(A,e=>e);function G(){return E(z)}function H(){A.set(!0)}function K(){A.set(!1)}window.addEventListener("online",H),window.addEventListener("offline",K);function Q(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var T={exports:{}};(function(e){var i=Object.prototype.hasOwnProperty,t="~";function a(){}Object.create&&(a.prototype=Object.create(null),new a().__proto__||(t=!1));function w(l,n,r){this.fn=l,this.context=n,this.once=r||!1}function v(l,n,r,o,f){if(typeof r!="function")throw new TypeError("The listener must be a function");var m=new w(r,o||l,f),c=t?t+n:n;return l._events[c]?l._events[c].fn?l._events[c]=[l._events[c],m]:l._events[c].push(m):(l._events[c]=m,l._eventsCount++),l}function _(l,n){--l._eventsCount===0?l._events=new a:delete l._events[n]}function p(){this._events=new a,this._eventsCount=0}p.prototype.eventNames=function(){var n=[],r,o;if(this._eventsCount===0)return n;for(o in r=this._events)i.call(r,o)&&n.push(t?o.slice(1):o);return Object.getOwnPropertySymbols?n.concat(Object.getOwnPropertySymbols(r)):n},p.prototype.listeners=function(n){var r=t?t+n:n,o=this._events[r];if(!o)return[];if(o.fn)return[o.fn];for(var f=0,m=o.length,c=new Array(m);f<m;f++)c[f]=o[f].fn;return c},p.prototype.listenerCount=function(n){var r=t?t+n:n,o=this._events[r];return o?o.fn?1:o.length:0},p.prototype.emit=function(n,r,o,f,m,c){var d=t?t+n:n;if(!this._events[d])return!1;var s=this._events[d],g=arguments.length,y,u;if(s.fn){switch(s.once&&this.removeListener(n,s.fn,void 0,!0),g){case 1:return s.fn.call(s.context),!0;case 2:return s.fn.call(s.context,r),!0;case 3:return s.fn.call(s.context,r,o),!0;case 4:return s.fn.call(s.context,r,o,f),!0;case 5:return s.fn.call(s.context,r,o,f,m),!0;case 6:return s.fn.call(s.context,r,o,f,m,c),!0}for(u=1,y=new Array(g-1);u<g;u++)y[u-1]=arguments[u];s.fn.apply(s.context,y)}else{var D=s.length,O;for(u=0;u<D;u++)switch(s[u].once&&this.removeListener(n,s[u].fn,void 0,!0),g){case 1:s[u].fn.call(s[u].context);break;case 2:s[u].fn.call(s[u].context,r);break;case 3:s[u].fn.call(s[u].context,r,o);break;case 4:s[u].fn.call(s[u].context,r,o,f);break;default:if(!y)for(O=1,y=new Array(g-1);O<g;O++)y[O-1]=arguments[O];s[u].fn.apply(s[u].context,y)}}return!0},p.prototype.on=function(n,r,o){return v(this,n,r,o,!1)},p.prototype.once=function(n,r,o){return v(this,n,r,o,!0)},p.prototype.removeListener=function(n,r,o,f){var m=t?t+n:n;if(!this._events[m])return this;if(!r)return _(this,m),this;var c=this._events[m];if(c.fn)c.fn===r&&(!f||c.once)&&(!o||c.context===o)&&_(this,m);else{for(var d=0,s=[],g=c.length;d<g;d++)(c[d].fn!==r||f&&!c[d].once||o&&c[d].context!==o)&&s.push(c[d]);s.length?this._events[m]=s.length===1?s[0]:s:_(this,m)}return this},p.prototype.removeAllListeners=function(n){var r;return n?(r=t?t+n:n,this._events[r]&&_(this,r)):(this._events=new a,this._eventsCount=0),this},p.prototype.off=p.prototype.removeListener,p.prototype.addListener=p.prototype.on,p.prefixed=t,p.EventEmitter=p,e.exports=p})(T);var R=T.exports;const X=Q(R),S=k("token",null),h=k("user",null),Y=x(h,e=>e),se=x(h,e=>!!e),re=x(h,e=>(e==null?void 0:e.permissions.includes("admin"))===!0),L=new X;function oe(){return!!E(Y)&&!!E(S)}async function ae(e,i){const t=await P.signInWithPassword({application_id:1,username_or_email:e,password:i});return U(t)}async function le(e,i,t,a){const w=await P.signUpWithPassword({application_id:+q,username:e,email:a,password:i,password_confirmation:t});return U(w)}async function U(e){N(e);const i=await b.current();return h.set(i),S.set(e),L.emit("user",i),i}function C(){h.set(null),S.set(null),N(void 0)}async function ce(e){await b.changeUsername({username:e}),h.update(i=>i?{...i,username:e}:null)}async function fe(e){await b.setPrimaryEmail(e),h.update(i=>{if(i){const t=i.emails.findIndex(a=>a.id===e);if(t!==-1){const a=i.emails.slice(),w=a[t];return i.email?a[t]=i.email:a.splice(t,1),{...i,email:w,emails:a}}}return i})}async function ue(e){await b.deleteEmail(e),h.update(i=>{if(i){const t=i.emails.findIndex(a=>a.id===e);if(t!==-1){const a=i.emails.slice();return a.splice(t,1),{...i,emails:a}}}return i})}async function pe(e,i){await P.confirmEmail(i),h.update(t=>{var a;if(t){if(((a=t.email)==null?void 0:a.id)===e)return{...t,email:{...t.email,confirmed:!0}};const w=t.emails.findIndex(v=>v.id===e);if(w!==-1){const v=t.emails.slice();return v[w]={...v[w],confirmed:!0},{...t,emails:v}}}return t})}async function me(e){const i=await b.createEmail({email:e});h.update(t=>{if(t){const a=t.emails.slice();return a.push(i),{...t,emails:a}}return t})}let J=!0;async function de(){try{let e=E(h);if(J){if(G()){const i=E(S);i?(N(i),e=await b.current(),h.set(e),L.emit("user",e)):(C(),e=null)}else e&&L.emit("user",e);J=!1}return e}catch(e){return console.error(e),C(),null}}var W;(W=F.middleware)==null||W.push({async post(e){e.response.status===401&&(C(),await B(`${M}/signin`))}});export{X as E,re as a,C as b,fe as c,ue as d,pe as e,me as f,de as g,ce as h,oe as i,ae as j,le as k,k as l,se as s,Y as u};
